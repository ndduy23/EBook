@model BookDb.Views.Documents.ViewDocumentModel

@{
    ViewData["Title"] = Model.GetDocumentTitle();
    var filePath = Url.Content(Model.GetFilePath());
    var fileExt = System.IO.Path.GetExtension(filePath)?.TrimStart('.').ToLowerInvariant() ?? "";
}

<style>
    :root {
        --primary-color: #667eea;
        --secondary-color: #764ba2;
    }

    body {
        overflow: hidden;
    }

    .viewer-container {
        display: flex;
        height: calc(100vh - 60px);
        position: fixed;
        top: 60px;
        left: 0;
        right: 0;
        bottom: 0;
    }

    /* Sidebar */
    .sidebar {
        width: 300px;
        background: #f8f9fa;
        border-right: 1px solid #dee2e6;
        overflow-y: auto;
        transition: transform 0.3s;
    }

        .sidebar.collapsed {
            transform: translateX(-300px);
        }

    .sidebar-header {
        padding: 15px;
        background: white;
        border-bottom: 1px solid #dee2e6;
        position: sticky;
        top: 0;
        z-index: 10;
    }

    .sidebar-tabs {
        display: flex;
        border-bottom: 1px solid #dee2e6;
    }

    .sidebar-tab {
        flex: 1;
        padding: 10px;
        text-align: center;
        cursor: pointer;
        border-bottom: 3px solid transparent;
        transition: all 0.3s;
    }

        .sidebar-tab.active {
            border-bottom-color: var(--primary-color);
            color: var(--primary-color);
            font-weight: bold;
        }

    .sidebar-content {
        padding: 15px;
    }

    /* Main Viewer */
    .pdf-viewer-main {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: #525659;
        position: relative;
    }

    /* Toolbar */
    .pdf-toolbar {
        background: #323639;
        padding: 10px 20px;
        display: flex;
        align-items: center;
        gap: 10px;
        color: white;
        flex-wrap: wrap;
    }

    .toolbar-group {
        display: flex;
        align-items: center;
        gap: 5px;
        padding: 0 10px;
        border-right: 1px solid #525659;
    }

        .toolbar-group:last-child {
            border-right: none;
        }

    .toolbar-btn {
        background: #525659;
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 4px;
        cursor: pointer;
        transition: background 0.2s;
    }

        .toolbar-btn:hover {
            background: #666;
        }

        .toolbar-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .toolbar-btn.active {
            background: var(--primary-color);
        }

    .page-input {
        width: 50px;
        text-align: center;
        background: #525659;
        border: 1px solid #666;
        color: white;
        padding: 5px;
        border-radius: 4px;
    }

    /* Canvas Container */
    .canvas-container {
        flex: 1;
        overflow: auto;
        display: flex;
        justify-content: center;
        align-items: flex-start;
        padding: 20px;
        position: relative;
    }

    #pdfCanvas {
        box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        background: white;
        cursor: crosshair;
    }

    .text-layer {
        position: absolute;
        left: 0;
        top: 0;
        right: 0;
        bottom: 0;
        overflow: hidden;
        opacity: 0.2;
        line-height: 1.0;
    }

        .text-layer > span {
            color: transparent;
            position: absolute;
            white-space: pre;
            cursor: text;
            transform-origin: 0% 0%;
        }

    /* Highlight Layer */
    .highlight-layer {
        position: absolute;
        left: 0;
        top: 0;
        pointer-events: none;
    }

    .highlight {
        position: absolute;
        background: rgba(255, 255, 0, 0.4);
        border: 1px solid rgba(255, 200, 0, 0.6);
        pointer-events: all;
        cursor: pointer;
    }

        .highlight:hover {
            background: rgba(255, 255, 0, 0.6);
        }

    /* Search Panel */
    .search-panel {
        position: absolute;
        top: 10px;
        right: 10px;
        background: white;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 100;
        display: none;
        min-width: 300px;
    }

        .search-panel.active {
            display: block;
        }

    .search-results {
        max-height: 200px;
        overflow-y: auto;
        margin-top: 10px;
    }

    .search-result-item {
        padding: 8px;
        cursor: pointer;
        border-bottom: 1px solid #eee;
        transition: background 0.2s;
    }

        .search-result-item:hover {
            background: #f0f0f0;
        }

        .search-result-item.active {
            background: #e3f2fd;
        }

    /* Bookmarks List */
    .bookmark-item {
        background: white;
        padding: 12px;
        margin-bottom: 10px;
        border-radius: 6px;
        border-left: 4px solid var(--primary-color);
        cursor: pointer;
        transition: all 0.2s;
    }

        .bookmark-item:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transform: translateX(5px);
        }

    .bookmark-text {
        font-size: 0.9em;
        color: #666;
        margin-top: 5px;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .bookmark-page {
        font-size: 0.8em;
        color: #999;
        margin-top: 5px;
    }

    .delete-bookmark {
        float: right;
        color: #dc3545;
        cursor: pointer;
        padding: 2px 8px;
        border-radius: 3px;
    }

        .delete-bookmark:hover {
            background: #dc3545;
            color: white;
        }

    /* Thumbnails */
    .thumbnail-item {
        margin-bottom: 15px;
        cursor: pointer;
        border: 2px solid transparent;
        border-radius: 4px;
        padding: 5px;
        transition: all 0.2s;
    }

        .thumbnail-item:hover {
            border-color: var(--primary-color);
        }

        .thumbnail-item.active {
            border-color: var(--primary-color);
            background: #e3f2fd;
        }

    .thumbnail-canvas {
        width: 100%;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .thumbnail-page {
        text-align: center;
        margin-top: 5px;
        font-size: 0.85em;
    }

    /* Loading */
    .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.2em;
        z-index: 1000;
    }

    /* Mobile Responsive */
    @@media (max-width: 768px) {
        .sidebar

    {
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        z-index: 100;
        transform: translateX(-300px);
    }

    .sidebar.show {
        transform: translateX(0);
    }

    .toolbar-group {
        padding: 0 5px;
    }

    }
</style>

<div class="viewer-container">
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h5 class="mb-0">@Model.GetDocumentTitle()</h5>
            <small class="text-muted">@Model.GetDocumentAuthor()</small>
        </div>

        <div class="sidebar-tabs">
            <div class="sidebar-tab active" data-tab="thumbnails">
                <i class="bi bi-grid-3x3"></i> Thumbnails
            </div>
            <div class="sidebar-tab" data-tab="bookmarks">
                <i class="bi bi-bookmark"></i> Bookmarks
            </div>
        </div>

        <div class="sidebar-content">
            <div class="tab-content active" data-content="thumbnails" id="thumbnailsContainer">
                <p class="text-muted">Đang tải thumbnails...</p>
            </div>
            <div class="tab-content" data-content="bookmarks" id="bookmarksContainer" style="display:none;">
                <p class="text-muted">Chưa có bookmark nào</p>
            </div>
        </div>
    </div>

    <!-- Main Viewer -->
    <div class="pdf-viewer-main">
        <!-- Toolbar -->
        <div class="pdf-toolbar">
            <div class="toolbar-group">
                <button class="toolbar-btn" id="toggleSidebar" title="Toggle Sidebar">
                    <i class="bi bi-layout-sidebar"></i>
                </button>
            </div>

            <div class="toolbar-group" id="pageControls">
                <button class="toolbar-btn" id="prevPage" title="Previous Page">
                    <i class="bi bi-chevron-left"></i>
                </button>
                <input type="number" id="pageNum" class="page-input" value="1" min="1">
                <span>/ <span id="pageCount">0</span></span>
                <button class="toolbar-btn" id="nextPage" title="Next Page">
                    <i class="bi bi-chevron-right"></i>
                </button>
            </div>

            <div class="toolbar-group">
                <button class="toolbar-btn" id="zoomOut" title="Zoom Out">
                    <i class="bi bi-dash-lg"></i>
                </button>
                <span id="zoomLevel">100%</span>
                <button class="toolbar-btn" id="zoomIn" title="Zoom In">
                    <i class="bi bi-plus-lg"></i>
                </button>
                <button class="toolbar-btn" id="zoomReset" title="Reset Zoom">
                    <i class="bi bi-arrow-clockwise"></i>
                </button>
            </div>

            <div class="toolbar-group">
                <button class="toolbar-btn" id="searchBtn" title="Search">
                    <i class="bi bi-search"></i> Search
                </button>
                <button class="toolbar-btn" id="highlightBtn" title="Highlight Mode">
                    <i class="bi bi-highlighter"></i> Highlight
                </button>
            </div>

            <div class="toolbar-group ms-auto">
                <button class="toolbar-btn" id="downloadBtn" title="Download">
                    <i class="bi bi-download"></i>
                </button>
                <button class="toolbar-btn" id="printBtn" title="Print">
                    <i class="bi bi-printer"></i>
                </button>
                <a href="/documents" class="toolbar-btn" title="Close">
                    <i class="bi bi-x-lg"></i>
                </a>
            </div>
        </div>

        <!-- Canvas / Generic Container -->
        <div class="canvas-container" id="canvasContainer">
            <div style="position: relative;" id="viewerHost">
                <!-- PDF canvas (shown only for PDFs) -->
                <canvas id="pdfCanvas" style="display:none"></canvas>
                <div class="text-layer" id="textLayer" style="display:none"></div>
                <div class="highlight-layer" id="highlightLayer" style="display:none"></div>

                <!-- Generic content for DOCX / Excel / Text will be injected into #genericViewer -->
                <div id="genericViewer" style="width:100%;"></div>
            </div>
        </div>

        <!-- Search Panel -->
        <div class="search-panel" id="searchPanel">
            <div class="d-flex align-items-center mb-2">
                <input type="text" class="form-control form-control-sm" id="searchInput" placeholder="Tìm kiếm trong tài liệu...">
                <button class="btn btn-sm btn-primary ms-2" id="searchExecute">
                    <i class="bi bi-search"></i>
                </button>
                <button class="btn btn-sm btn-secondary ms-1" id="closeSearch">
                    <i class="bi bi-x"></i>
                </button>
            </div>
            <div id="searchResults" class="search-results"></div>
        </div>

        <!-- Loading Overlay -->
        <div class="loading-overlay" id="loadingOverlay" style="display:flex">
            <div class="text-center">
                <div class="spinner-border text-light" role="status"></div>
                <div class="mt-3" id="loadingText">Đang tải tài liệu...</div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <script>
        // -------------------------
        // Cấu hình & biến toàn cục
        // -------------------------
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        const pdfUrl = '@filePath';
        const documentId = @Model.GetDocumentId();
        const fileExt = '@fileExt'.toLowerCase();

        const canvas = document.getElementById('pdfCanvas');
        const ctx = canvas.getContext ? canvas.getContext('2d') : null;
        const textLayerDiv = document.getElementById('textLayer');
        const highlightLayer = document.getElementById('highlightLayer');
        const genericViewer = document.getElementById('genericViewer');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const loadingText = document.getElementById('loadingText');

        // Variables for PDF viewer (kept separate)
        let pdfDoc = null;
        let pageNum = 1;
        let pageRendering = false;
        let pageNumPending = null;
        let scale = 1.5;
        let bookmarks = [];
        let isHighlightMode = false;
        let searchResults = [];
        let currentSearchIndex = -1;

        // Khởi tạo theo loại file
        (function initByExtension() {
            switch (fileExt) {
                case 'pdf':
                    initPdfViewer(pdfUrl);
                    break;
                case 'doc':
                case 'docx':
                    initDocxViewer(pdfUrl);
                    break;
                case 'xls':
                case 'xlsx':
                    initExcelViewer(pdfUrl);
                    break;
                case 'txt':
                case 'csv':
                    initTextViewer(pdfUrl);
                    break;
                default:
                    showUnsupported();
                    break;
            }
        })();

        // -------------------------
        // Các hàm hiển thị chung
        // -------------------------
        function showUnsupported() {
            loadingOverlay.style.display = 'none';
            genericViewer.innerHTML = `<div style="color:white; padding:20px;">Định dạng không được hỗ trợ: .${fileExt}</div>`;
            document.getElementById('pageControls').style.display = 'none';
        }

        // Sidebar toggle
        document.getElementById('toggleSidebar').addEventListener('click', function () {
            document.getElementById('sidebar').classList.toggle('collapsed');
        });

        // Sidebar tabs
        document.querySelectorAll('.sidebar-tab').forEach(tab => {
            tab.addEventListener('click', function () {
                const target = this.dataset.tab;

                document.querySelectorAll('.sidebar-tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');

                document.querySelectorAll('.tab-content').forEach(content => {
                    content.style.display = content.dataset.content === target ? 'block' : 'none';
                });
            });
        });

        // Toolbar: download / print
        document.getElementById('downloadBtn').addEventListener('click', function () {
            window.open(pdfUrl, '_blank');
        });

        document.getElementById('printBtn').addEventListener('click', function () {
            window.open(pdfUrl, '_blank');
        });

        // Search panel toggles
        document.getElementById('searchBtn').addEventListener('click', function () {
            document.getElementById('searchPanel').classList.toggle('active');
            document.getElementById('searchInput').focus();
        });

        document.getElementById('closeSearch').addEventListener('click', function () {
            document.getElementById('searchPanel').classList.remove('active');
        });

        document.getElementById('searchExecute').addEventListener('click', performSearch);
        document.getElementById('searchInput').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') performSearch();
        });

        // Highlight mode toggle
        document.getElementById('highlightBtn').addEventListener('click', function () {
            isHighlightMode = !isHighlightMode;
            this.classList.toggle('active');
            if (fileExt === 'pdf') {
                canvas.style.cursor = isHighlightMode ? 'crosshair' : 'default';
            } else {
                // For generic viewers allow text selection highlight
                genericViewer.style.cursor = isHighlightMode ? 'text' : 'default';
            }
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function (e) {
            if (e.ctrlKey || e.metaKey) {
                if (e.key === 'f') {
                    e.preventDefault();
                    document.getElementById('searchBtn').click();
                }
            } else if (e.key === 'ArrowLeft') {
                if (fileExt === 'pdf') document.getElementById('prevPage').click();
            } else if (e.key === 'ArrowRight') {
                if (fileExt === 'pdf') document.getElementById('nextPage').click();
            }
        });

        // -------------------------
        // DOCX Viewer (Mammoth)
        // -------------------------
        async function initDocxViewer(url) {
            // Prepare UI
            document.getElementById('pageControls').style.display = 'none'; // no page controls for docx (single long content)
            textLayerDiv.style.display = 'none';
            highlightLayer.style.display = 'none';
            canvas.style.display = 'none';
            genericViewer.innerHTML = '';
            loadingText.innerText = 'Đang tải DOCX...';
            loadingOverlay.style.display = 'flex';

            try {
                const resp = await fetch(url);
                const arrayBuffer = await resp.arrayBuffer();

                const result = await mammoth.convertToHtml({ arrayBuffer });
                loadingOverlay.style.display = 'none';

                // Create viewer container with same look as PDF area
                genericViewer.innerHTML = `
                    <div id="docxViewer" style="background:white; padding:30px; max-width:1100px; margin:20px auto; overflow:auto; color:black;">
                        ${result.value}
                    </div>
                `;

                applyDocxFeatures();
            } catch (err) {
                console.error(err);
                loadingOverlay.style.display = 'none';
                genericViewer.innerHTML = `<div style="color:white; padding:20px;">Không thể tải file Word.</div>`;
            }
        }

        function applyDocxFeatures() {
            const viewer = document.getElementById('docxViewer');

            // Zoom
            document.getElementById('zoomIn').onclick = () => changeScaleGeneric(viewer, 1.15);
            document.getElementById('zoomOut').onclick = () => changeScaleGeneric(viewer, 0.85);
            document.getElementById('zoomReset').onclick = () => {
                viewer.style.transform = 'scale(1)';
                document.getElementById('zoomLevel').innerText = '100%';
            };

            // Simple search inside docx
            window.performSearchForGeneric = function () {
                const q = document.getElementById('searchInput').value.trim();
                const resultsDiv = document.getElementById('searchResults');
                resultsDiv.innerHTML = '';
                if (!q) { resultsDiv.innerHTML = '<div class="text-muted">Nhập từ để tìm</div>'; return; }

                const text = viewer.innerText || viewer.textContent;
                const idx = text.toLowerCase().indexOf(q.toLowerCase());
                if (idx === -1) {
                    resultsDiv.innerHTML = '<div class="text-muted">Không tìm thấy kết quả</div>';
                } else {
                    // show context
                    const start = Math.max(0, idx - 50);
                    const end = Math.min(text.length, idx + 100);
                    resultsDiv.innerHTML = `<div class="search-result-item active" onclick="window.gotoGenericSearch()"><strong>Ở tài liệu</strong><br><small>...${text.substring(start, end)}...</small></div>`;
                    window.gotoGenericSearch = function () {
                        // try to scroll to first match element by using range search in DOM
                        const walker = document.createTreeWalker(viewer, NodeFilter.SHOW_TEXT, null, false);
                        let node, acc = 0;
                        while (node = walker.nextNode()) {
                            const nodeText = node.nodeValue || '';
                            const lower = nodeText.toLowerCase();
                            const qLower = document.getElementById('searchInput').value.toLowerCase();
                            const pos = lower.indexOf(qLower);
                            if (pos !== -1) {
                                // highlight temporarily
                                const range = document.createRange();
                                range.setStart(node, pos);
                                range.setEnd(node, pos + qLower.length);
                                const rect = range.getBoundingClientRect();
                                // scroll viewer so that rect is visible
                                viewer.scrollTop = viewer.scrollTop + rect.top - 100;
                                return;
                            }
                        }
                    };
                }
            };

            // Hook performSearch button to generic search
            document.getElementById('searchExecute').onclick = function () { window.performSearchForGeneric(); };
            document.getElementById('searchInput').onkeypress = function (e) { if (e.key === 'Enter') window.performSearchForGeneric(); };

            // Highlight / Bookmark (basic): user selects text and confirm to save bookmark
            viewer.addEventListener('mouseup', function () {
                if (!isHighlightMode) return;
                const selection = window.getSelection();
                const selectedText = selection.toString().trim();
                if (!selectedText) return;

                if (confirm(`Lưu bookmark: "${selectedText.substring(0, 120)}..."?`)) {
                    const bookmark = {
                        id: Date.now(),
                        documentId: documentId,
                        page: 1,
                        text: selectedText,
                        x: 0, y: 0, width: 0, height: 0,
                        timestamp: new Date().toISOString()
                    };
                    loadBookmarksFromStorage();
                    bookmarks.push(bookmark);
                    saveBookmarksToStorage();
                    displayBookmarks();
                    alert('✅ Đã lưu bookmark!');
                }
                selection.removeAllRanges();
            });

            // Initialize bookmarks
            loadBookmarksFromStorage();
            displayBookmarks();
        }

        // -------------------------
        // Excel Viewer (SheetJS)
        // -------------------------
        async function initExcelViewer(url) {
            // UI adjustments
            document.getElementById('pageControls').style.display = 'none';
            textLayerDiv.style.display = 'none';
            highlightLayer.style.display = 'none';
            canvas.style.display = 'none';
            genericViewer.innerHTML = '';
            loadingText.innerText = 'Đang tải Excel...';
            loadingOverlay.style.display = 'flex';

            try {
                const resp = await fetch(url);
                const arrayBuffer = await resp.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer, { type: 'array' });

                loadingOverlay.style.display = 'none';

                const container = document.createElement('div');
                container.style.background = 'white';
                container.style.padding = '20px';
                container.style.maxWidth = '1200px';
                container.style.margin = '20px auto';
                container.style.overflow = 'auto';
                genericViewer.appendChild(container);

                workbook.SheetNames.forEach(sheetName => {
                    const html = XLSX.utils.sheet_to_html(workbook.Sheets[sheetName], { id: `sheet_${sheetName}` });
                    const title = document.createElement('h5');
                    title.innerText = sheetName;
                    container.appendChild(title);

                    const wrapper = document.createElement('div');
                    wrapper.innerHTML = html;
                    container.appendChild(wrapper);
                });

                // Zoom handlers for generic excel viewer
                document.getElementById('zoomIn').onclick = () => changeScaleGeneric(container, 1.15);
                document.getElementById('zoomOut').onclick = () => changeScaleGeneric(container, 0.85);
                document.getElementById('zoomReset').onclick = () => {
                    container.style.transform = 'scale(1)';
                    document.getElementById('zoomLevel').innerText = '100%';
                };

                // Basic search for excel viewer (search within textContent)
                window.performSearchForGeneric = function () {
                    const q = document.getElementById('searchInput').value.trim();
                    const resultsDiv = document.getElementById('searchResults');
                    resultsDiv.innerHTML = '';
                    if (!q) { resultsDiv.innerHTML = '<div class="text-muted">Nhập từ để tìm</div>'; return; }

                    const text = container.innerText || container.textContent;
                    const idx = text.toLowerCase().indexOf(q.toLowerCase());
                    if (idx === -1) {
                        resultsDiv.innerHTML = '<div class="text-muted">Không tìm thấy kết quả</div>';
                    } else {
                        const start = Math.max(0, idx - 50);
                        const end = Math.min(text.length, idx + 100);
                        resultsDiv.innerHTML = `<div class="search-result-item active"><strong>Trong trang tính</strong><br><small>...${text.substring(start, end)}...</small></div>`;
                    }
                };

                document.getElementById('searchExecute').onclick = function () { window.performSearchForGeneric(); };
                document.getElementById('searchInput').onkeypress = function (e) { if (e.key === 'Enter') window.performSearchForGeneric(); };

                // Bookmarks: allow selecting text (similar to docx)
                container.addEventListener('mouseup', function () {
                    if (!isHighlightMode) return;
                    const selection = window.getSelection();
                    const selectedText = selection.toString().trim();
                    if (!selectedText) return;

                    if (confirm(`Lưu bookmark: "${selectedText.substring(0, 120)}..."?`)) {
                        const bookmark = {
                            id: Date.now(),
                            documentId: documentId,
                            page: 1,
                            text: selectedText,
                            x: 0, y: 0, width: 0, height: 0,
                            timestamp: new Date().toISOString()
                        };
                        loadBookmarksFromStorage();
                        bookmarks.push(bookmark);
                        saveBookmarksToStorage();
                        displayBookmarks();
                        alert('✅ Đã lưu bookmark!');
                    }
                    selection.removeAllRanges();
                });

                loadBookmarksFromStorage();
                displayBookmarks();

            } catch (err) {
                console.error(err);
                loadingOverlay.style.display = 'none';
                genericViewer.innerHTML = `<div style="color:white; padding:20px;">Không thể tải file Excel.</div>`;
            }
        }

        // -------------------------
        // Text Viewer
        // -------------------------
        async function initTextViewer(url) {
            document.getElementById('pageControls').style.display = 'none';
            textLayerDiv.style.display = 'none';
            highlightLayer.style.display = 'none';
            canvas.style.display = 'none';
            genericViewer.innerHTML = '';
            loadingText.innerText = 'Đang tải văn bản...';
            loadingOverlay.style.display = 'flex';

            try {
                const resp = await fetch(url);
                const txt = await resp.text();
                loadingOverlay.style.display = 'none';

                genericViewer.innerHTML = `<pre id="textViewer" style="white-space: pre-wrap; background:white; color:black; padding:20px; max-width:1100px; margin:20px auto;">${escapeHtml(txt)}</pre>`;

                const viewer = document.getElementById('textViewer');

                // Zoom
                document.getElementById('zoomIn').onclick = () => changeScaleGeneric(viewer, 1.15);
                document.getElementById('zoomOut').onclick = () => changeScaleGeneric(viewer, 0.85);
                document.getElementById('zoomReset').onclick = () => {
                    viewer.style.transform = 'scale(1)';
                    document.getElementById('zoomLevel').innerText = '100%';
                };

                // Search
                window.performSearchForGeneric = function () {
                    const q = document.getElementById('searchInput').value.trim();
                    const resultsDiv = document.getElementById('searchResults');
                    resultsDiv.innerHTML = '';
                    if (!q) { resultsDiv.innerHTML = '<div class="text-muted">Nhập từ để tìm</div>'; return; }

                    const text = viewer.innerText || viewer.textContent;
                    const idx = text.toLowerCase().indexOf(q.toLowerCase());
                    if (idx === -1) {
                        resultsDiv.innerHTML = '<div class="text-muted">Không tìm thấy kết quả</div>';
                    } else {
                        const start = Math.max(0, idx - 50);
                        const end = Math.min(text.length, idx + 100);
                        resultsDiv.innerHTML = `<div class="search-result-item active"><strong>Văn bản</strong><br><small>...${text.substring(start, end)}...</small></div>`;
                    }
                };

                document.getElementById('searchExecute').onclick = function () { window.performSearchForGeneric(); };
                document.getElementById('searchInput').onkeypress = function (e) { if (e.key === 'Enter') window.performSearchForGeneric(); };

                // Bookmarks via selection
                viewer.addEventListener('mouseup', function () {
                    if (!isHighlightMode) return;
                    const selection = window.getSelection();
                    const selectedText = selection.toString().trim();
                    if (!selectedText) return;
                    if (confirm(`Lưu bookmark: "${selectedText.substring(0, 120)}..."?`)) {
                        const bookmark = {
                            id: Date.now(),
                            documentId: documentId,
                            page: 1,
                            text: selectedText,
                            x: 0, y: 0, width: 0, height: 0,
                            timestamp: new Date().toISOString()
                        };
                        loadBookmarksFromStorage();
                        bookmarks.push(bookmark);
                        saveBookmarksToStorage();
                        displayBookmarks();
                        alert('✅ Đã lưu bookmark!');
                    }
                    selection.removeAllRanges();
                });

                loadBookmarksFromStorage();
                displayBookmarks();

            } catch (err) {
                console.error(err);
                loadingOverlay.style.display = 'none';
                genericViewer.innerHTML = `<div style="color:white; padding:20px;">Không thể tải file văn bản.</div>`;
            }
        }

        // -------------------------
        // PDF Viewer (KEEP ORIGINAL FEATURES)
        // -------------------------
        function initPdfViewer(pdfUrl) {
            // show/hide relevant elements
            canvas.style.display = 'block';
            textLayerDiv.style.display = 'block';
            highlightLayer.style.display = 'block';
            genericViewer.innerHTML = '';

            loadingText.innerText = 'Đang tải PDF...';
            loadingOverlay.style.display = 'flex';

            pdfjsLib.getDocument(pdfUrl).promise.then(function (pdf) {
                pdfDoc = pdf;
                document.getElementById('pageCount').textContent = pdf.numPages;
                loadingOverlay.style.display = 'none';

                // Load bookmarks from storage
                loadBookmarksFromStorage();

                // initial render
                renderPage(pageNum);
                generateThumbnails();
                displayBookmarks();
            }).catch(function (error) {
                console.error('Error loading PDF:', error);
                loadingOverlay.innerHTML = '<div class="text-danger">Không thể tải PDF</div>';
            });

            // Render Page
            function renderPage(num) {
                pageRendering = true;

                pdfDoc.getPage(num).then(function (page) {
                    const viewport = page.getViewport({ scale: scale });
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;

                    const renderContext = {
                        canvasContext: ctx,
                        viewport: viewport
                    };

                    const renderTask = page.render(renderContext);
                    renderTask.promise.then(function () {
                        pageRendering = false;
                        if (pageNumPending !== null) {
                            renderPage(pageNumPending);
                            pageNumPending = null;
                        }

                        // Render text layer for selection
                        renderTextLayer(page, viewport);

                        // Render highlights
                        renderHighlights();
                    });
                });

                document.getElementById('pageNum').value = num;
            }

            // Render Text Layer
            function renderTextLayer(page, viewport) {
                textLayerDiv.innerHTML = '';
                textLayerDiv.style.width = canvas.width + 'px';
                textLayerDiv.style.height = canvas.height + 'px';

                page.getTextContent().then(function (textContent) {
                    pdfjsLib.renderTextLayer({
                        textContent: textContent,
                        container: textLayerDiv,
                        viewport: viewport,
                        textDivs: []
                    });
                });
            }

            // Queue Page Render
            function queueRenderPage(num) {
                if (pageRendering) {
                    pageNumPending = num;
                } else {
                    renderPage(num);
                }
            }

            // Navigation
            document.getElementById('prevPage').addEventListener('click', function () {
                if (pageNum <= 1) return;
                pageNum--;
                queueRenderPage(pageNum);
            });

            document.getElementById('nextPage').addEventListener('click', function () {
                if (pageNum >= pdfDoc.numPages) return;
                pageNum++;
                queueRenderPage(pageNum);
            });

            document.getElementById('pageNum').addEventListener('change', function () {
                const num = parseInt(this.value);
                if (num > 0 && num <= pdfDoc.numPages) {
                    pageNum = num;
                    queueRenderPage(pageNum);
                }
            });

            // Zoom
            document.getElementById('zoomIn').addEventListener('click', function () {
                scale += 0.25;
                queueRenderPage(pageNum);
                updateZoomDisplay();
            });

            document.getElementById('zoomOut').addEventListener('click', function () {
                if (scale > 0.5) {
                    scale -= 0.25;
                    queueRenderPage(pageNum);
                    updateZoomDisplay();
                }
            });

            document.getElementById('zoomReset').addEventListener('click', function () {
                scale = 1.5;
                queueRenderPage(pageNum);
                updateZoomDisplay();
            });

            function updateZoomDisplay() {
                document.getElementById('zoomLevel').textContent = Math.round(scale * 100) + '%';
            }

            // Text Selection and Highlighting (PDF)
            textLayerDiv.addEventListener('mouseup', function () {
                if (!isHighlightMode) return;

                const selection = window.getSelection();
                const selectedText = selection.toString().trim();

                if (selectedText.length > 0) {
                    const range = selection.getRangeAt(0);
                    const rect = range.getBoundingClientRect();
                    const canvasRect = canvas.getBoundingClientRect();

                    const highlight = {
                        page: pageNum,
                        text: selectedText,
                        x: rect.left - canvasRect.left,
                        y: rect.top - canvasRect.top,
                        width: rect.width,
                        height: rect.height
                    };

                    if (confirm(`Lưu bookmark: "${selectedText.substring(0, 50)}..."?`)) {
                        saveBookmark(highlight);
                    }

                    selection.removeAllRanges();
                }
            });

            // Render Highlights
            function renderHighlights() {
                highlightLayer.innerHTML = '';
                highlightLayer.style.width = canvas.width + 'px';
                highlightLayer.style.height = canvas.height + 'px';

                bookmarks.filter(b => b.page === pageNum).forEach(function (bookmark, index) {
                    const div = document.createElement('div');
                    div.className = 'highlight';
                    div.style.left = bookmark.x + 'px';
                    div.style.top = bookmark.y + 'px';
                    div.style.width = bookmark.width + 'px';
                    div.style.height = bookmark.height + 'px';
                    div.title = bookmark.text;
                    div.onclick = function () {
                        if (confirm('Xóa bookmark này?')) {
                            deleteBookmarkById(bookmark.id);
                        }
                    };
                    highlightLayer.appendChild(div);
                });
            }

            // Save Bookmark
            function saveBookmark(highlight) {
                const bookmark = {
                    id: Date.now(),
                    documentId: documentId,
                    page: highlight.page,
                    text: highlight.text,
                    x: highlight.x,
                    y: highlight.y,
                    width: highlight.width,
                    height: highlight.height,
                    timestamp: new Date().toISOString()
                };

                loadBookmarksFromStorage();
                bookmarks.push(bookmark);
                saveBookmarksToStorage();

                renderHighlights();
                displayBookmarks();

                alert('✅ Đã lưu bookmark!');
            }

            // Load Bookmarks
            // (functions loadBookmarksFromStorage & saveBookmarksToStorage defined globally below)
            // Display Bookmarks
            function displayBookmarks() {
                const container = document.getElementById('bookmarksContainer');

                if (!bookmarks || bookmarks.length === 0) {
                    container.innerHTML = '<p class="text-muted">Chưa có bookmark nào. Bôi đen text và save để tạo bookmark.</p>';
                    return;
                }

                container.innerHTML = bookmarks.map((bookmark, index) => `
                    <div class="bookmark-item" onclick="gotoBookmark(${bookmark.page})">
                        <div>
                            <strong>Bookmark ${index + 1}</strong>
                            <span class="delete-bookmark" onclick="event.stopPropagation(); deleteBookmarkById(${bookmark.id})">
                                <i class="bi bi-trash"></i>
                            </span>
                        </div>
                        <div class="bookmark-text">${escapeHtml(bookmark.text)}</div>
                        <div class="bookmark-page">Trang ${bookmark.page}</div>
                    </div>
                `).join('');
            }

            // Delete Bookmark by id
            function deleteBookmarkById(id) {
                loadBookmarksFromStorage();
                const idx = bookmarks.findIndex(b => b.id === id);
                if (idx !== -1) {
                    bookmarks.splice(idx, 1);
                    saveBookmarksToStorage();
                    displayBookmarks();
                    renderHighlights();
                }
            }

            // Goto Bookmark
            window.gotoBookmark = function (page) {
                pageNum = page;
                queueRenderPage(pageNum);
            };

            // Search (PDF full-text scan)
            async function performSearch() {
                const query = document.getElementById('searchInput').value.trim().toLowerCase();
                if (!query) return;

                searchResults = [];
                const resultsDiv = document.getElementById('searchResults');
                resultsDiv.innerHTML = '<div class="text-muted">Đang tìm kiếm...</div>';

                for (let i = 1; i <= pdfDoc.numPages; i++) {
                    const page = await pdfDoc.getPage(i);
                    const textContent = await page.getTextContent();
                    const text = textContent.items.map(item => item.str).join(' ');

                    if (text.toLowerCase().includes(query)) {
                        const index = text.toLowerCase().indexOf(query);
                        const context = text.substring(Math.max(0, index - 50), Math.min(text.length, index + 100));
                        searchResults.push({ page: i, context: context });
                    }
                }

                if (searchResults.length === 0) {
                    resultsDiv.innerHTML = '<div class="text-muted">Không tìm thấy kết quả</div>';
                } else {
                    resultsDiv.innerHTML = searchResults.map((result, index) => `
                        <div class="search-result-item" onclick="gotoSearchResult(${index})">
                            <strong>Trang ${result.page}</strong><br>
                            <small>...${escapeHtml(result.context)}...</small>
                        </div>
                    `).join('');
                }
            }

            // Expose performSearch for PDF area
            window.performSearch = performSearch;

            window.gotoSearchResult = function (index) {
                pageNum = searchResults[index].page;
                queueRenderPage(pageNum);
                currentSearchIndex = index;

                // Highlight active result in list
                document.querySelectorAll('.search-result-item').forEach((item, i) => {
                    item.classList.toggle('active', i === index);
                });
            };

            // Generate Thumbnails
            async function generateThumbnails() {
                const container = document.getElementById('thumbnailsContainer');
                container.innerHTML = '';

                for (let i = 1; i <= Math.min(pdfDoc.numPages, 20); i++) {
                    const page = await pdfDoc.getPage(i);
                    const viewport = page.getViewport({ scale: 0.3 });

                    const thumbnailCanvas = document.createElement('canvas');
                    const thumbnailCtx = thumbnailCanvas.getContext('2d');
                    thumbnailCanvas.height = viewport.height;
                    thumbnailCanvas.width = viewport.width;

                    await page.render({
                        canvasContext: thumbnailCtx,
                        viewport: viewport
                    }).promise;

                    const div = document.createElement('div');
                    div.className = 'thumbnail-item';
                    if (i === pageNum) div.classList.add('active');
                    div.onclick = function () {
                        pageNum = i;
                        queueRenderPage(pageNum);
                        document.querySelectorAll('.thumbnail-item').forEach(item => item.classList.remove('active'));
                        div.classList.add('active');
                    };

                    thumbnailCanvas.className = 'thumbnail-canvas';
                    div.appendChild(thumbnailCanvas);

                    const pageLabel = document.createElement('div');
                    pageLabel.className = 'thumbnail-page';
                    pageLabel.textContent = 'Trang ' + i;
                    div.appendChild(pageLabel);

                    container.appendChild(div);
                }
            }

            // Keyboard: hook Ctrl+F for PDF search
            document.addEventListener('keydown', function (e) {
                if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'f') {
                    e.preventDefault();
                    document.getElementById('searchBtn').click();
                }
            });

            // Hook searchExecute to PDF search
            document.getElementById('searchExecute').onclick = function () { window.performSearch(); };
            document.getElementById('searchInput').onkeypress = function (e) { if (e.key === 'Enter') window.performSearch(); };

        } // end initPdfViewer

        // -------------------------
        // Bookmarks storage helpers (localStorage)
        // -------------------------
        function loadBookmarksFromStorage() {
            const stored = localStorage.getItem('pdf_bookmarks_' + documentId);
            if (stored) {
                try {
                    bookmarks = JSON.parse(stored);
                } catch (e) {
                    bookmarks = [];
                }
            } else {
                bookmarks = [];
            }
        }

        function saveBookmarksToStorage() {
            localStorage.setItem('pdf_bookmarks_' + documentId, JSON.stringify(bookmarks));
        }

        function displayBookmarks() {
            const container = document.getElementById('bookmarksContainer');

            if (!bookmarks || bookmarks.length === 0) {
                container.innerHTML = '<p class="text-muted">Chưa có bookmark nào. Bôi đen text và save để tạo bookmark.</p>';
                return;
            }

            container.innerHTML = bookmarks.map((bookmark, index) => `
                <div class="bookmark-item" onclick="gotoBookmark(${bookmark.page})">
                    <div>
                        <strong>Bookmark ${index + 1}</strong>
                        <span class="delete-bookmark" onclick="event.stopPropagation(); deleteBookmarkById(${bookmark.id})">
                            <i class="bi bi-trash"></i>
                        </span>
                    </div>
                    <div class="bookmark-text">${escapeHtml(bookmark.text)}</div>
                    <div class="bookmark-page">Trang ${bookmark.page}</div>
                </div>
            `).join('');
        }

        // -------------------------
        // Utility helpers
        // -------------------------
        function escapeHtml(str) {
            if (!str) return '';
            return (str + '').replace(/[&<>"'`=\/]/g, function (s) {
                return ({
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#39;',
                    '/': '&#x2F;',
                    '`': '&#x60;',
                    '=': '&#x3D;'
                })[s];
            });
        }

        function changeScaleGeneric(element, factor) {
            const computed = element.style.transform || 'scale(1)';
            const m = computed.match(/scale\(([\d.]+)\)/);
            let current = m ? parseFloat(m[1]) : 1;
            current = current * factor;
            element.style.transform = `scale(${current.toFixed(2)})`;
            element.style.transformOrigin = 'center top';
            document.getElementById('zoomLevel').innerText = Math.round(current * 100) + '%';
        }

        // small wrapper: performSearch in generic viewers will be set when those viewers init
        // If not set, default to PDF search if available
        document.getElementById('searchExecute').addEventListener('click', function () {
            if (typeof window.performSearchForGeneric === 'function') {
                window.performSearchForGeneric();
            } else if (typeof window.performSearch === 'function') {
                window.performSearch();
            }
        });

        // expose gotoBookmark for non-PDF viewers too (they will just scroll)
        window.gotoBookmark = function (page) {
            if (fileExt === 'pdf') {
                // handled earlier
                pageNum = page;
                // render handled by gotoBookmark in PDF code
            } else {
                // for generic, try to scroll to a block containing bookmark text
                loadBookmarksFromStorage();
                const found = bookmarks.find(b => b.page === page);
                if (found) {
                    const q = found.text.split(/\s+/).slice(0, 6).join(' ');
                    if (q) {
                        // try to find element containing q
                        const hostText = genericViewer.innerText || genericViewer.textContent || '';
                        if (hostText.toLowerCase().indexOf(q.toLowerCase()) !== -1) {
                            // naive scroll to top (can't precise locate without complex logic)
                            genericViewer.scrollTop = 0;
                            alert('Đã chuyển tới bookmark (nếu tìm thấy nội dung trong viewer).');
                        }
                    }
                }
            }
        };

        // Initialize bookmarks display now if any (for generic viewers, their init functions call this too)
        loadBookmarksFromStorage();
        displayBookmarks();
    </script>
}
