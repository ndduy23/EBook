@model BookDb.Views.Documents.ViewDocumentModel

@{
    ViewData["Title"] = Model.Title;
}

<style>
    #documentViewer {
        width: 100%;
        height: 800px;
        border: 1px solid #ddd;
        border-radius: 8px;
    }

    .document-toolbar {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 10px;
    }

    .page-controls {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .search-controls {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .bookmark-controls {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .page-info {
        font-weight: 500;
        padding: 5px 15px;
        background: white;
        border-radius: 4px;
    }

    #searchBox {
        min-width: 250px;
    }

    .highlight {
        background-color: yellow;
        padding: 2px 0;
    }

    .current-highlight {
        background-color: orange;
    }
</style>

<div class="container-fluid">
    <h2>@Model.GetDocumentTitle()</h2>

    <div class="row mb-3">
        <div class="col-md-12">
            <p class="mb-1"><strong>Tác giả:</strong> @Model.GetDocumentAuthor()</p>
            <p class="mb-1"><strong>Lĩnh vực:</strong> @Model.GetDocumentCategory()</p>
            <p class="mb-1"><strong>Ngày tạo:</strong> @Model.GetFormattedDate()</p>
            @if (!string.IsNullOrEmpty(Model.GetDocumentDescription()))
            {
                <p class="mb-1"><strong>Mô tả:</strong> @Model.GetDocumentDescription()</p>
            }
        </div>
    </div>

    <div class="document-toolbar">
        <!-- Page Navigation -->
        <div class="page-controls">
            <button type="button" class="btn btn-secondary btn-sm" id="prevPage" disabled>
                <i class="bi bi-chevron-left"></i> Trước
            </button>
            <span class="page-info">
                Trang <span id="currentPage">1</span> / <span id="totalPages">1</span>
            </span>
            <button type="button" class="btn btn-secondary btn-sm" id="nextPage">
                Sau <i class="bi bi-chevron-right"></i>
            </button>
        </div>

        <!-- Search -->
        <div class="search-controls">
            <input type="text"
                   class="form-control form-control-sm"
                   id="searchBox"
                   placeholder="Tìm kiếm trong tài liệu...">
            <button type="button" class="btn btn-info btn-sm" id="searchBtn">
                <i class="bi bi-search"></i> Tìm
            </button>
            <button type="button" class="btn btn-outline-secondary btn-sm" id="clearSearch" style="display:none;">
                <i class="bi bi-x"></i>
            </button>
        </div>

        <!-- Bookmark -->
        <div class="bookmark-controls auth-only">
            <button type="button" class="btn btn-primary btn-sm" id="addBookmarkBtn">
                <i class="bi bi-bookmark-plus"></i> Thêm Bookmark
            </button>
            <button type="button" class="btn btn-danger btn-sm" id="deleteBookmarkBtn" style="display:none;">
                <i class="bi bi-trash"></i> Xóa Bookmark
            </button>
        </div>

        <!-- Guest message -->
        <div class="guest-only" style="display:none;">
            <small class="text-muted">
                <i class="bi bi-lock"></i>
                <a href="/auth/login">Đăng nhập</a> để sử dụng bookmark
            </small>
        </div>
    </div>

    <!-- Document Viewer -->
    <div id="documentViewer">
        <iframe id="docFrame"
                src="@Url.Content(Model.GetFilePath())"
                style="width:100%; height:100%; border:none;">
        </iframe>
    </div>

    <div class="mt-3">
        <a asp-action="Index" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> Quay lại danh sách
        </a>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            const documentId = @Model.GetDocumentId();
            const documentTitle = '@Model.GetSafeTitle()';
            let currentPage = 1;
            let totalPages = 1;
            let currentBookmarkId = null;

            // Initialize viewer based on file type
            const fileType = '@Model.GetFileExtension()';

            if (fileType === '.pdf') {
                initPdfViewer();
            } else {
                // For non-PDF, hide page controls
                $('.page-controls').hide();
            }

            // Page navigation
            $('#prevPage').on('click', function() {
                if (currentPage > 1) {
                    currentPage--;
                    updatePage();
                }
            });

            $('#nextPage').on('click', function() {
                if (currentPage < totalPages) {
                    currentPage++;
                    updatePage();
                }
            });

            function updatePage() {
                $('#currentPage').text(currentPage);
                updatePageControls();
                checkBookmark();
            }

            function updatePageControls() {
                $('#prevPage').prop('disabled', currentPage <= 1);
                $('#nextPage').prop('disabled', currentPage >= totalPages);
            }

            // Search functionality
            $('#searchBtn, #searchBox').on('click keypress', function(e) {
                if (e.type === 'click' || e.which === 13) {
                    performSearch();
                }
            });

            $('#clearSearch').on('click', function() {
                $('#searchBox').val('');
                clearSearch();
                $(this).hide();
            });

            function performSearch() {
                const query = $('#searchBox').val().trim();
                if (!query) return;

                // For PDF, use PDF.js search API
                // For Office docs, use browser find
                if (fileType === '.pdf') {
                    searchInPdf(query);
                } else {
                    searchInIframe(query);
                }

                $('#clearSearch').show();
            }

            function searchInIframe(query) {
                const iframe = document.getElementById('docFrame');
                if (!iframe || !iframe.contentWindow) return;

                try {
                    const found = iframe.contentWindow.find(query, false, false, true, false, true, false);
                    if (!found) {
                        alert('Không tìm thấy: ' + query);
                    }
                } catch (e) {
                    console.warn('Search not supported in this document type');
                }
            }

            function clearSearch() {
                const iframe = document.getElementById('docFrame');
                if (iframe && iframe.contentWindow) {
                    try {
                        iframe.contentWindow.find('', false, false, false, false, true, false);
                    } catch (e) {}
                }
            }

            // Bookmark management
            $('#addBookmarkBtn').on('click', function() {
                addBookmark();
            });

            $('#deleteBookmarkBtn').on('click', function() {
                if (confirm('Xóa bookmark này?')) {
                    deleteBookmark();
                }
            });

            function checkBookmark() {
                if (!window.JwtHelper || !window.JwtHelper.isAuthenticated()) {
                    return;
                }

                $.ajax({
                    url: '/api/bookmarks/check',
                    type: 'GET',
                    data: { documentId: documentId, pageNumber: currentPage },
                    headers: {
                        'Authorization': 'Bearer ' + window.JwtHelper.getToken()
                    },
                    success: function(response) {
                        if (response.exists) {
                            currentBookmarkId = response.bookmarkId;
                            $('#addBookmarkBtn').hide();
                            $('#deleteBookmarkBtn').show();
                        } else {
                            currentBookmarkId = null;
                            $('#addBookmarkBtn').show();
                            $('#deleteBookmarkBtn').hide();
                        }
                    },
                    error: function() {
                        // If error, show add button
                        $('#addBookmarkBtn').show();
                        $('#deleteBookmarkBtn').hide();
                    }
                });
            }

            function addBookmark() {
                const url = window.location.href;

                $.ajax({
                    url: '/api/bookmarks/create',
                    type: 'POST',
                    contentType: 'application/json',
                    headers: {
                        'Authorization': 'Bearer ' + window.JwtHelper.getToken()
                    },
                    data: JSON.stringify({
                        documentId: documentId,
                        pageNumber: currentPage,
                        title: `${documentTitle} - Trang ${currentPage}`,
                        url: url
                    }),
                    success: function(response) {
                        if (response.success) {
                            window.NotificationHub.showLocal('✅ Đã thêm bookmark', 'success');
                            checkBookmark();
                        } else {
                            window.NotificationHub.showLocal('❌ ' + response.message, 'error');
                        }
                    },
                    error: function(xhr) {
                        let msg = 'Không thể thêm bookmark';
                        if (xhr.responseJSON && xhr.responseJSON.message) {
                            msg = xhr.responseJSON.message;
                        }
                        window.NotificationHub.showLocal('❌ ' + msg, 'error');
                    }
                });
            }

            function deleteBookmark() {
                if (!currentBookmarkId) return;

                $.ajax({
                    url: '/api/bookmarks/' + currentBookmarkId,
                    type: 'DELETE',
                    headers: {
                        'Authorization': 'Bearer ' + window.JwtHelper.getToken()
                    },
                    success: function(response) {
                        if (response.success) {
                            window.NotificationHub.showLocal('✅ Đã xóa bookmark', 'success');
                            checkBookmark();
                        } else {
                            window.NotificationHub.showLocal('❌ ' + response.message, 'error');
                        }
                    },
                    error: function() {
                        window.NotificationHub.showLocal('❌ Không thể xóa bookmark', 'error');
                    }
                });
            }

            function initPdfViewer() {
                // If PDF.js is available, use it for better control
                // Otherwise, use iframe with page parameter
                const iframe = $('#docFrame');
                const src = iframe.attr('src');

                // Try to detect total pages (this requires PDF.js or server-side processing)
                // For now, we'll use a simple approach
                totalPages = 100; // Default, will be updated if we can detect actual pages
                $('#totalPages').text(totalPages);
                updatePageControls();
                checkBookmark();
            }

            // Initialize auth UI
            if (window.JwtHelper && window.JwtHelper.isAuthenticated()) {
                $('.auth-only').show();
                $('.guest-only').hide();
                checkBookmark();
            } else {
                $('.auth-only').hide();
                $('.guest-only').show();
            }
        });
    </script>
}