@model BookDb.Views.Documents.IndexModel

@{
    ViewData["Title"] = Model.Title;
}

<style>
    .guest-notice {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 20px;
        animation: fadeInDown 0.5s ease-out;
    }

    @@keyframes fadeInDown {
        from

    {
        opacity: 0;
        transform: translateY(-20px);
    }

    to {
        opacity: 1;
        transform: translateY(0);
    }

    }

    .auth-required-overlay {
        position: relative;
    }

        .auth-required-overlay::after {
            content: "üîí ƒêƒÉng nh·∫≠p ƒë·ªÉ s·ª≠ d·ª•ng";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: bold;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            white-space: nowrap;
            z-index: 1000;
        }

        .auth-required-overlay:hover::after {
            opacity: 1;
        }

    .disabled-for-guest {
        opacity: 0.5;
        cursor: not-allowed;
        pointer-events: none;
    }

    /* Document Card Styles */
    .documents-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 24px;
        margin-top: 20px;
    }

    .document-card {
        background: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
        display: flex;
        flex-direction: column;
        height: 100%;
    }

        .document-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
        }

    .document-cover {
        width: 100%;
        height: 320px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        overflow: hidden;
    }

        .document-cover::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at top right, rgba(255, 255, 255, 0.2), transparent);
        }

    .cover-icon {
        font-size: 80px;
        color: rgba(255, 255, 255, 0.9);
        z-index: 1;
    }

    .cover-extension {
        position: absolute;
        top: 15px;
        right: 15px;
        background: rgba(0, 0, 0, 0.3);
        color: white;
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
        backdrop-filter: blur(10px);
    }

    .document-body {
        padding: 20px;
        flex: 1;
        display: flex;
        flex-direction: column;
    }

    .document-title {
        font-size: 18px;
        font-weight: 600;
        color: #333;
        margin-bottom: 10px;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        line-height: 1.4;
        min-height: 50px;
    }

    .document-meta {
        display: flex;
        flex-direction: column;
        gap: 8px;
        margin-bottom: 15px;
        flex: 1;
    }

    .meta-item {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
        color: #666;
    }

        .meta-item i {
            color: #667eea;
            width: 16px;
        }

    .document-actions {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        margin-top: auto;
        padding-top: 15px;
        border-top: 1px solid #f0f0f0;
    }

    .btn-action {
        flex: 1;
        min-width: 80px;
        padding: 8px 12px;
        font-size: 13px;
        border-radius: 6px;
        transition: all 0.2s;
    }

        .btn-action i {
            font-size: 12px;
        }

    /* View Toggle */
    .view-toggle {
        display: flex;
        gap: 8px;
        background: #f8f9fa;
        padding: 4px;
        border-radius: 8px;
    }

    .view-toggle-btn {
        padding: 8px 16px;
        border: none;
        background: transparent;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s;
    }

        .view-toggle-btn.active {
            background: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 80px 20px;
        color: #999;
    }

        .empty-state i {
            font-size: 80px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .empty-state h4 {
            color: #666;
            margin-bottom: 10px;
        }

    /* Loading Spinner */
    .loading-spinner {
        display: none;
        text-align: center;
        padding: 40px;
    }

        .loading-spinner.active {
            display: block;
        }

    /* Responsive */
    @@media (max-width: 768px) {
        .documents-grid

    { 
        grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
        gap: 16px;
    }

    .document-cover {
        height: 280px;
    }

    .cover-icon {
        font-size: 60px;
    }

    }

    @@media (max-width: 576px) {
        .documents-grid

    {
        grid-template-columns: 1fr;
    }

    }
</style>

<!-- Guest Notice -->
<div id="guestNotice" class="guest-notice" style="display:none;">
    <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
        <div>
            <h5 class="mb-2">üëã Ch√†o m·ª´ng b·∫°n ƒë·∫øn v·ªõi BookDb!</h5>
            <p class="mb-0">
                B·∫°n ƒëang ·ªü ch·∫ø ƒë·ªô <strong>Kh√°ch</strong>.
                B·∫°n c√≥ th·ªÉ <strong>xem t√†i li·ªáu</strong>, nh∆∞ng c·∫ßn
                <strong>ƒëƒÉng nh·∫≠p</strong> ƒë·ªÉ th√™m, s·ª≠a, x√≥a t√†i li·ªáu.
            </p>
        </div>
        <div class="d-flex gap-2">
            <a href="/auth/login" class="btn btn-light">
                <i class="bi bi-box-arrow-in-right"></i> ƒêƒÉng nh·∫≠p
            </a>
            <a href="/auth/register" class="btn btn-outline-light">
                <i class="bi bi-person-plus"></i> ƒêƒÉng k√Ω
            </a>
        </div>
    </div>
</div>

<!-- Header -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-grid-3x3-gap"></i> @Model.Title</h2>

    <!-- View Toggle -->
    <div class="view-toggle d-none d-md-flex">
        <button class="view-toggle-btn active" data-view="grid">
            <i class="bi bi-grid-3x3-gap"></i> Grid
        </button>
        <button class="view-toggle-btn" data-view="list">
            <i class="bi bi-list-ul"></i> List
        </button>
    </div>
</div>

<!-- Toolbar -->
<div class="row mb-4">
    <div class="col-md-8 mb-3 mb-md-0">
        <!-- Add Document Button -->
        <div class="auth-only d-inline-block" style="display:none;">
            <a asp-action="Create" class="btn btn-primary">
                <i class="bi bi-file-earmark-plus"></i> Th√™m t√†i li·ªáu m·ªõi
            </a>
        </div>

        <!-- Guest Disabled Button -->
        <div class="guest-only d-inline-block">
            <div class="auth-required-overlay d-inline-block">
                <button class="btn btn-secondary disabled-for-guest">
                    <i class="bi bi-file-earmark-plus"></i> Th√™m t√†i li·ªáu m·ªõi
                </button>
            </div>
        </div>

        <!-- Filter Buttons -->
        <div class="btn-group ms-2" role="group">
            <a asp-action="Index" asp-route-onlyMine="false"
               class="btn btn-outline-secondary @(Model.OnlyMine ? "" : "active")">
                T·∫•t c·∫£
            </a>
            <a asp-action="Index" asp-route-onlyMine="true"
               class="btn btn-outline-primary @(Model.OnlyMine ? "active" : "")">
                C·ªßa t√¥i
            </a>
        </div>

        <!-- Refresh Button -->
        <button type="button" class="btn btn-info ms-2" id="refreshBtn">
            <span class="spinner-border spinner-border-sm d-none" id="refreshSpinner"></span>
            <i class="bi bi-arrow-clockwise"></i> L√†m m·ªõi
        </button>
    </div>

    <!-- Search Box -->
    <div class="col-md-4">
        <form method="get" asp-action="Index" id="searchForm">
            <div class="input-group">
                <input type="text" name="q" id="searchQuery" class="form-control"
                       placeholder="T√¨m ki·∫øm t√†i li·ªáu..." value="@Model.SearchQuery" />
                <button type="submit" class="btn btn-info">
                    <i class="bi bi-search"></i>
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Loading Spinner -->
<div class="loading-spinner" id="loadingSpinner">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-3 text-muted">ƒêang t·∫£i t√†i li·ªáu...</p>
</div>

<!-- Documents Grid -->
<div class="documents-grid" id="documentsGrid">
    @if (Model.HasDocuments())
    {
        @foreach (var doc in Model.Documents)
        {
            var fileExt = System.IO.Path.GetExtension(doc.FileName)?.TrimStart('.').ToLowerInvariant() ?? "file";
            var iconClass = fileExt switch
            {
                "pdf" => "bi-file-earmark-pdf",
                "doc" or "docx" => "bi-file-earmark-word",
                "xls" or "xlsx" => "bi-file-earmark-excel",
                "txt" => "bi-file-earmark-text",
                _ => "bi-file-earmark"
            };
            var gradientClass = fileExt switch
            {
                "pdf" => "linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%)",
                "doc" or "docx" => "linear-gradient(135deg, #4e73df 0%, #224abe 100%)",
                "xls" or "xlsx" => "linear-gradient(135deg, #1cc88a 0%, #13855c 100%)",
                "txt" => "linear-gradient(135deg, #36b9cc 0%, #258391 100%)",
                _ => "linear-gradient(135deg, #667eea 0%, #764ba2 100%)"
            };

            <div class="document-card" data-document-id="@doc.Id">
                <!-- Cover -->
                <div class="document-cover" style="background: @gradientClass;">
                    <i class="bi @iconClass cover-icon"></i>
                    <span class="cover-extension">@fileExt</span>
                </div>

                <!-- Body -->
                <div class="document-body">
                    <h3 class="document-title">@doc.Title</h3>

                    <div class="document-meta">
                        <div class="meta-item">
                            <i class="bi bi-tag-fill"></i>
                            <span>@(string.IsNullOrEmpty(doc.Category) ? "Ch∆∞a ph√¢n lo·∫°i" : doc.Category)</span>
                        </div>
                        <div class="meta-item">
                            <i class="bi bi-person-fill"></i>
                            <span>@(string.IsNullOrEmpty(doc.Author) ? "Kh√¥ng r√µ" : doc.Author)</span>
                        </div>
                        <div class="meta-item">
                            <i class="bi bi-calendar-fill"></i>
                            <span>@Model.GetFormattedDate(doc.CreatedAt)</span>
                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="document-actions">
                        <!-- View Button (Everyone) -->
                        <a asp-action="ViewDocument" asp-route-id="@doc.Id"
                           class="btn btn-success btn-action">
                            <i class="bi bi-eye"></i> Xem
                        </a>

                        <!-- Edit Button (Owner/Admin) -->
                        <a asp-action="Edit" asp-route-id="@doc.Id"
                           class="btn btn-warning btn-action admin-only owner-only d-none"
                           data-owner-id="@doc.OwnerId">
                            <i class="bi bi-pencil"></i> S·ª≠a
                        </a>

                        <!-- Delete Button (Owner/Admin) -->
                        <button type="button"
                                class="btn btn-danger btn-action delete-btn admin-only owner-only d-none"
                                data-id="@doc.Id"
                                data-title="@doc.Title"
                                data-owner-id="@doc.OwnerId">
                            <i class="bi bi-trash"></i> X√≥a
                        </button>
                    </div>
                </div>
            </div>
        }
    }
    else
    {
        <div class="empty-state" style="grid-column: 1 / -1;">
            <i class="bi bi-inbox"></i>
            <h4>Kh√¥ng c√≥ t√†i li·ªáu n√†o</h4>
            <p class="text-muted">
                @if (Model.OnlyMine)
                {
                    <span>B·∫°n ch∆∞a c√≥ t√†i li·ªáu n√†o. H√£y th√™m t√†i li·ªáu ƒë·∫ßu ti√™n!</span>
                }
                else
                {
                    <span>Ch∆∞a c√≥ t√†i li·ªáu trong h·ªá th·ªëng.</span>
                }
            </p>
            <a asp-action="Create" class="btn btn-primary mt-3 auth-only" style="display:none;">
                <i class="bi bi-plus-circle"></i> Th√™m t√†i li·ªáu ƒë·∫ßu ti√™n
            </a>
        </div>
    }
</div>

<!-- Loading Overlay -->
<div id="loadingOverlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.3); z-index:9998;">
    <div style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); background:white; padding:20px; border-radius:8px;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">ƒêang x·ª≠ l√Ω...</p>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            // Check authentication and update UI
            updateUIBasedOnAuth();

            // View Toggle
            $('.view-toggle-btn').on('click', function() {
                const view = $(this).data('view');
                $('.view-toggle-btn').removeClass('active');
                $(this).addClass('active');

                // TODO: Implement list view if needed
                if (view === 'list') {
                    // Switch to list view
                    console.log('List view not implemented yet');
                }
            });

            // Ajax search with debounce
            let searchTimeout;
            $('#searchQuery').on('input', function () {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(function () {
                    performSearch();
                }, 500);
            });

            function updateUIBasedOnAuth() {
                const isAuthenticated = window.JwtHelper && window.JwtHelper.isAuthenticated();
                const user = window.JwtHelper ? window.JwtHelper.getUser() : null;
                const isAdmin = window.JwtHelper ? window.JwtHelper.hasRole('Admin') : false;

                if (isAuthenticated && user) {
                    $('.auth-only').show();
                    $('.guest-only').hide();
                    $('#guestNotice').hide();

                    // Show/hide edit and delete buttons based on ownership
                    $('.owner-only, .admin-only').each(function() {
                        const ownerId = $(this).data('owner-id');
                        if (isAdmin || (ownerId && ownerId === user.id)) {
                            $(this).removeClass('d-none');
                        }
                    });
                } else {
                    $('.auth-only').hide();
                    $('.guest-only').show();
                    $('#guestNotice').show();
                    $('.owner-only, .admin-only').addClass('d-none');
                }
            }

            function performSearch() {
                const query = $('#searchQuery').val();
                showLoading();

                $.ajax({
                    url: '@Url.Action("Index", "Documents")',
                    type: 'GET',
                    data: {
                        q: query,
                        onlyMine: '@Model.OnlyMine'.toLowerCase() === 'true'
                    },
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    success: function (response) {
                        $('#documentsGrid').html($(response).find('#documentsGrid').html());
                        updateUIBasedOnAuth();
                        hideLoading();
                    },
                    error: function () {
                        hideLoading();
                        if (window.NotificationHub) {
                            window.NotificationHub.showLocal('C√≥ l·ªói khi t√¨m ki·∫øm', 'error');
                        }
                    }
                });
            }

            // Refresh button
            $('#refreshBtn').on('click', function () {
                loadDocuments();
            });

            function loadDocuments() {
                const query = $('#searchQuery').val();
                showLoading();

                $.ajax({
                    url: '@Url.Action("Index", "Documents")',
                    type: 'GET',
                    data: {
                        q: query,
                        onlyMine: '@Model.OnlyMine'.toLowerCase() === 'true'
                    },
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    success: function (response) {
                        $('#documentsGrid').html($(response).find('#documentsGrid').html());
                        updateUIBasedOnAuth();
                        hideLoading();

                        if (window.NotificationHub) {
                            window.NotificationHub.showLocal('ƒê√£ l√†m m·ªõi danh s√°ch', 'success');
                        }
                    },
                    error: function () {
                        hideLoading();
                        if (window.NotificationHub) {
                            window.NotificationHub.showLocal('C√≥ l·ªói khi l√†m m·ªõi', 'error');
                        }
                    }
                });
            }

            // Delete document
            $(document).on('click', '.delete-btn', function () {
                if (!window.JwtHelper.isAuthenticated()) {
                    alert('Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ x√≥a t√†i li·ªáu');
                    return;
                }

                const documentId = $(this).data('id');
                const title = $(this).data('title');

                if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a t√†i li·ªáu "' + title + '"?')) {
                    return;
                }

                $.ajax({
                    url: '/api/documents/' + documentId,
                    type: 'DELETE',
                    headers: {
                        'Authorization': 'Bearer ' + window.JwtHelper.getToken(),
                        'X-CSRF-TOKEN': $('input[name="__RequestVerificationToken"]').val()
                    },
                    beforeSend: function () {
                        $('#loadingOverlay').show();
                    },
                    success: function (response) {
                        if (window.NotificationHub) {
                            window.NotificationHub.showLocal('ƒê√£ x√≥a t√†i li·ªáu: ' + title, 'success');
                        }
                        loadDocuments();
                    },
                    error: function (xhr) {
                        let errorMsg = 'C√≥ l·ªói khi x√≥a t√†i li·ªáu';
                        if (xhr.status === 404) {
                            errorMsg = 'Kh√¥ng t√¨m th·∫•y t√†i li·ªáu';
                        } else if (xhr.status === 401) {
                            errorMsg = 'Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ x√≥a t√†i li·ªáu';
                        } else if (xhr.status === 403) {
                            errorMsg = 'B·∫°n kh√¥ng c√≥ quy·ªÅn x√≥a t√†i li·ªáu n√†y';
                        }
                        if (window.NotificationHub) {
                            window.NotificationHub.showLocal(errorMsg, 'error');
                        }
                    },
                    complete: function () {
                        $('#loadingOverlay').hide();
                    }
                });
            });

            // Listen for SignalR document updates
            if (window.NotificationHub && window.NotificationHub.connection) {
                setupDocumentUpdateListener();
            } else {
                setTimeout(setupDocumentUpdateListener, 1000);
            }

            function setupDocumentUpdateListener() {
                if (!window.NotificationHub || !window.NotificationHub.connection) {
                    console.warn('NotificationHub not ready');
                    return;
                }

                const connection = window.NotificationHub.connection;

                connection.on('DocumentUpdated', function (data) {
                    console.log('Document updated:', data);
                    loadDocuments();
                });

                connection.on('DocumentAdded', function (data) {
                    console.log('Document added:', data);
                    loadDocuments();
                });

                connection.on('DocumentDeleted', function (data) {
                    console.log('Document deleted:', data);
                    loadDocuments();
                });
            }

            function showLoading() {
                $('#refreshSpinner').removeClass('d-none');
                $('#loadingSpinner').addClass('active');
                $('#documentsGrid').css('opacity', '0.5');
            }

            function hideLoading() {
                $('#refreshSpinner').addClass('d-none');
                $('#loadingSpinner').removeClass('active');
                $('#documentsGrid').css('opacity', '1');
            }
        });
    </script>
}

@* Anti-forgery token for AJAX *@
<form id="__AjaxAntiForgeryForm" style="display:none">
    @Html.AntiForgeryToken()
</form>